#!/usr/bin/env bash
mkdir -p "${HOME}/.config"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
mkdir -p "${HOME}/.local/share/devbox/global/current"
mkdir -p "${HOME}/.local/share/devbox/global/default"
ln -sf "${SCRIPT_DIR}/devbox/devbox.json" \
      "${HOME}/.local/share/devbox/global/current/devbox.json"
ln -sf "${SCRIPT_DIR}/devbox/devbox.json" \
      "${HOME}/.local/share/devbox/global/default/devbox.json"
eval "$(devbox global shellenv --init-hook)"
devbox global install

stow .

SNIPPET='eval "$(devbox global shellenv --init-hook)"'
for rc in ".bashrc" ".zshrc"; do
  TARGET="${HOME}/${rc}"
  # create file if missing
  [ -f "${TARGET}" ] || touch "${TARGET}"
  # only append if not already present
  if ! grep -Fxq "${SNIPPET}" "${TARGET}"; then
    printf "\n# Devbox global shell integration\n%s\n" "${SNIPPET}" >> "${TARGET}"
  fi
done
